# Streamlit MQTT 監控應用程式 - 產品需求文件 (PRD)

## 專案概述

建立一個基於 Streamlit 的 Web 應用程式，作為 MQTT 訂閱者，用於即時監控和顯示物聯網設備的狀態與感測器數據。

## 應用程式角色

- **MQTT 訂閱者**：應用程式將訂閱指定的 MQTT 主題，接收來自物聯網設備的即時數據

## 使用者介面需求

### 顯示項目

1. **電燈狀態顯示**
   - 顯示電燈的開/關狀態
   - 建議使用視覺化指示器（如圖示或顏色標記）

2. **客廳溫度顯示**
   - 即時顯示當前客廳溫度數值
   - 單位：攝氏度 (°C)

3. **客廳濕度顯示**
   - 即時顯示當前客廳濕度數值
   - 單位：百分比 (%)

4. **溫濕度歷史圖表**
   - 使用圖表（如折線圖）展示溫濕度的歷史趨勢
   - X 軸：日期和時間
   - Y 軸：溫度/濕度數值
   - 建議使用雙 Y 軸或分開的圖表來同時顯示溫度和濕度

## 功能需求

### 核心功能

1. **即時數據顯示**
   - 從 MQTT Broker 訂閱並接收即時數據
   - 自動更新介面上的顯示內容
   - 支援即時數據刷新

2. **數據儲存**
   - 將訂閱收到的所有數據自動儲存為 Excel 檔案
   - 建議包含以下欄位：
     - 時間戳記 (Timestamp)
     - 電燈狀態 (Light Status)
     - 溫度 (Temperature)
     - 濕度 (Humidity)
   - 檔案命名建議包含日期時間，便於管理

### 技術規格建議

- **MQTT 訂閱主題**：需定義具體的主題名稱（例如：`home/living_room/temperature`, `home/living_room/humidity`, `home/living_room/light`）
- **MQTT Broker 連線**：需設定 Broker 位址、埠號、認證資訊（如需要）
- **數據更新頻率**：建議定義數據接收和更新的頻率
- **Excel 儲存頻率**：建議定義數據儲存的頻率（即時儲存或批次儲存）

## 非功能性需求

- **效能**：應用程式應能即時響應 MQTT 訊息
- **穩定性**：需處理 MQTT 連線中斷的情況
- **使用者體驗**：介面應清晰易讀，數據更新流暢

---

## 開發完成狀態

### ✅ 已實現功能

本專案已完成開發並通過測試，所有需求功能均已實現。

### 技術實現架構

#### 1. **系統架構**

```
┌─────────────────┐
│  MQTT Broker    │ (Mosquitto)
│  (localhost)    │
└────────┬────────┘
         │ MQTT 訊息
         ▼
┌─────────────────┐
│ MQTT Subscriber │ (mqtt_subscriber.py)
│   模組          │
└────────┬────────┘
         │
         ├──► Streamlit UI (app.py)
         │    └──► 即時顯示 + 圖表
         │
         └──► Data Storage (data_storage.py)
              └──► Excel 檔案儲存
```

#### 2. **核心模組說明**

**`app.py`** - Streamlit 主應用程式
- 實現即時監控儀表板
- 整合 MQTT 訂閱與數據顯示
- 使用 Plotly 繪製互動式圖表
- 支援自動刷新功能
- 改進的連線管理（避免刷新時斷線）
- 安全的 Session State 管理

**`mqtt_subscriber.py`** - MQTT 訂閱者模組
- 實現 MQTT 連線管理
- 處理訊息接收與解析
- 支援 JSON 與純文字格式
- 執行緒安全的數據緩存

**`data_storage.py`** - 數據儲存模組
- 自動儲存數據到 Excel 檔案
- 支援批次儲存（可設定間隔）
- 檔案命名包含時間戳記
- 支援數據讀取與合併

**`config.py`** - 配置管理
- 集中管理所有設定
- 支援環境變數覆蓋
- 易於維護與擴展

#### 3. **使用者介面實現**

✅ **電燈狀態顯示**
- 使用圖示與顏色標記（🟢 開啟 / ⚫ 關閉 / ❓ 未知）
- 顯示最後更新時間

✅ **溫度顯示**
- 即時數值顯示（°C）
- 支援小數點顯示
- 顯示最後更新時間

✅ **濕度顯示**
- 即時數值顯示（%）
- 支援小數點顯示
- 顯示最後更新時間

✅ **溫濕度歷史圖表**
- 使用 Plotly 互動式圖表
- 雙 Y 軸設計（溫度/濕度）
- X 軸顯示日期時間
- 支援縮放與懸停顯示詳細資訊
- 最多保留 1000 筆歷史數據

✅ **側邊欄控制**
- MQTT 連線/斷線控制
- 自動刷新開關
- 手動儲存數據按鈕
- 連線狀態指示

✅ **數據表格**
- 可展開查看歷史數據表格
- 支援排序與篩選

#### 4. **功能實現細節**

**即時數據顯示**
- ✅ 自動訂閱 MQTT 主題：`home/living_room/#`
- ✅ 支援多種訊息格式（數值、文字、JSON）
- ✅ 自動更新顯示（可設定自動刷新間隔）
- ✅ 執行緒安全的數據處理

**數據儲存**
- ✅ 自動儲存到 `data/` 目錄
- ✅ Excel 檔案格式（使用 openpyxl）
- ✅ 檔案命名：`mqtt_data_YYYYMMDD_HHMMSS.xlsx`
- ✅ 包含欄位：時間戳記、電燈狀態、溫度、濕度
- ✅ 支援批次儲存（預設每 10 筆儲存一次，可設定為即時儲存）

**MQTT 連線管理**
- ✅ 自動重連機制
- ✅ 連線狀態顯示
- ✅ 錯誤處理與日誌記錄
- ✅ 連線穩定性改進（避免 Streamlit 刷新時斷線）
- ✅ 執行緒安全的連線狀態檢查

### 技術規格（已實現）

#### MQTT 設定
- **Broker 位址**：`localhost`（可在 config.py 修改）
- **埠號**：`1883`（標準 MQTT 埠）
- **訂閱主題**：
  - `home/living_room/temperature` - 溫度
  - `home/living_room/humidity` - 濕度
  - `home/living_room/light` - 電燈狀態
  - `home/living_room/#` - 所有客廳主題（萬用字元）
- **QoS 等級**：1（確保訊息送達）

#### 數據格式支援
- **數值格式**：`25.5`（溫度/濕度）
- **文字格式**：`on` / `off`（電燈狀態）
- **JSON 格式**：
  ```json
  {
    "temperature": 25.5,
    "humidity": 60.0,
    "light": "on"
  }
  ```

#### 數據更新頻率
- **MQTT 接收**：即時（無延遲）
- **UI 刷新**：可設定自動刷新（預設每 2 秒）
- **Excel 儲存**：每 10 筆數據儲存一次（可在 config.py 設定為 0 即時儲存）

### 檔案結構

```
lesson6/
├── app.py                    # Streamlit 主應用程式
├── config.py                 # 配置檔案
├── mqtt_subscriber.py        # MQTT 訂閱者模組
├── data_storage.py          # 數據儲存模組
├── test_mqtt_publish.py     # MQTT 測試發布腳本（Python）
├── test_mqtt.sh            # Shell 測試腳本（自動啟動虛擬環境）
├── test_mqtt_simple.sh      # Shell 快速測試腳本
├── run.sh                   # 應用程式啟動腳本
├── PRD.md                   # 產品需求文件（本檔案）
├── README.md                # 使用說明文件
├── TEST_GUIDE.md            # 測試指南
└── data/                    # 數據儲存目錄（自動建立）
    └── mqtt_data_*.xlsx     # Excel 數據檔案
```

### 依賴套件

- `streamlit>=1.28.0` - Web 應用程式框架
- `paho-mqtt>=2.1.0` - MQTT 客戶端
- `pandas>=2.0.0` - 數據處理
- `openpyxl>=3.1.0` - Excel 檔案處理
- `plotly>=5.17.0` - 互動式圖表

### 部署與執行

#### 安裝步驟
```bash
# 1. 安裝依賴
cd /home/pi/Documents/GitHub/20205_10_26_chihlee_pi_pico_Steve
uv sync

# 2. 確保 MQTT Broker 運行
sudo systemctl status mosquitto
# 如未運行：sudo systemctl start mosquitto
```

#### 執行應用程式
```bash
# 方法 1: 使用啟動腳本
cd lesson6
./run.sh

# 方法 2: 手動執行
source ../.venv/bin/activate
streamlit run app.py
```

#### 測試方法

**單次測試模式**（推薦用於快速測試）
```bash
# 使用 Shell 腳本（自動啟動虛擬環境）
./test_mqtt.sh

# 或使用 Python 腳本
source ../.venv/bin/activate
python test_mqtt_publish.py
```
單次測試會發送：
- 電燈狀態（ON）
- 溫度數據
- 濕度數據
- JSON 格式的完整數據
- **30 筆連續的模擬感測器數據**（每 1 秒一次）

**持續發布模式**（用於長時間測試）
```bash
# 使用預設值：每 1 秒發布一次，共 100 次
./test_mqtt.sh continuous

# 自訂參數
./test_mqtt.sh continuous 0.5 200  # 每 0.5 秒一次，共 200 次
./test_mqtt.sh continuous 1 100    # 每 1 秒一次，共 100 次
```

**手動發布測試**
```bash
mosquitto_pub -h localhost -t "home/living_room/temperature" -m "25.5" -q 1
mosquitto_pub -h localhost -t "home/living_room/humidity" -m "60.0" -q 1
mosquitto_pub -h localhost -t "home/living_room/light" -m "on" -q 1
```

詳細測試說明請參考 `TEST_GUIDE.md`。

### 功能驗證清單

- ✅ MQTT 連線與訂閱功能正常
- ✅ 電燈狀態即時顯示（支援 on/off/未知狀態）
- ✅ 溫度即時顯示（支援小數點）
- ✅ 濕度即時顯示（支援小數點）
- ✅ 溫濕度歷史圖表正常顯示與更新
- ✅ 數據自動儲存為 Excel 檔案
- ✅ 手動儲存功能正常
- ✅ 自動刷新功能正常（不會中斷 MQTT 連線）
- ✅ 連線狀態顯示正常
- ✅ 支援多種 MQTT 訊息格式
- ✅ 執行緒安全處理
- ✅ 錯誤處理機制
- ✅ 高頻率數據接收測試（每 0.5-1 秒）
- ✅ 大量數據處理測試（100+ 筆連續數據）

### 已知限制與未來改進

#### 當前限制
1. 歷史數據最多保留 1000 筆（記憶體限制）
2. Excel 儲存為批次模式（預設每 10 筆，可設定為即時儲存）
3. 單一 MQTT Broker 連線（未支援多 Broker）
4. 測試腳本預設頻率為 1 秒（可自訂，但建議不低於 0.1 秒以避免過載）

#### 未來改進建議
1. 支援數據庫儲存（SQLite/PostgreSQL）
2. 支援多設備監控
3. 添加數據匯出功能（CSV/JSON）
4. 添加告警功能（溫度/濕度異常）
5. 支援 MQTT 認證（用戶名/密碼）
6. 添加數據統計分析功能
7. 支援自訂主題訂閱
8. 添加數據過濾與搜尋功能

### 測試結果

- ✅ 單一訊息發布測試通過
- ✅ 連續數據發布測試通過（30 筆，每 1 秒一次）
- ✅ 持續發布測試通過（100 筆，每 1 秒一次）
- ✅ JSON 格式數據解析測試通過
- ✅ Excel 儲存功能測試通過
- ✅ 圖表顯示與更新測試通過
- ✅ 連線中斷處理測試通過
- ✅ 多主題訂閱測試通過
- ✅ Streamlit 刷新時連線穩定性測試通過
- ✅ 高頻率數據接收測試通過（每 0.5-1 秒）

### 文件與資源

- **使用說明**：`README.md`
- **測試指南**：`TEST_GUIDE.md`
- **產品需求**：`PRD.md`（本檔案）

---

## 總結

本專案已完整實現所有需求功能，包括：
- ✅ 即時 MQTT 數據監控
- ✅ 視覺化儀表板介面
- ✅ 歷史數據圖表
- ✅ 自動數據儲存
- ✅ 完整的測試工具（支援高頻率、大量數據測試）
- ✅ 穩定的連線管理（避免刷新時斷線）

**最新更新（v1.1）**：
- ✅ 測試腳本優化：單次測試從 5 筆增加到 30 筆
- ✅ 持續發布模式預設：每 1 秒 100 次（可自訂）
- ✅ MQTT 連線穩定性改進：解決 Streamlit 刷新時斷線問題
- ✅ 自動重連機制優化

應用程式已可正常運行，並通過各項功能測試，包括高頻率數據接收和大批量數據處理測試。所有程式碼遵循最佳實踐，具有良好的可維護性和擴展性。 
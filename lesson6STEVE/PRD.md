<<<<<<< HEAD
# Streamlit MQTT 監控應用程式 - 產品需求文件 (PRD)

## 專案概述

建立一個基於 Streamlit 的 Web 應用程式，作為 MQTT 訂閱者，用於即時監控和顯示物聯網設備的狀態與感測器數據。

## 應用程式角色

- **MQTT 訂閱者**：應用程式將訂閱指定的 MQTT 主題，接收來自物聯網設備的即時數據

## 使用者介面需求

### 顯示項目

1. **電燈狀態顯示**
   - 顯示電燈的開/關狀態
   - 建議使用視覺化指示器（如圖示或顏色標記）

2. **客廳溫度顯示**
   - 即時顯示當前客廳溫度數值
   - 單位：攝氏度 (°C)

3. **客廳濕度顯示**
   - 即時顯示當前客廳濕度數值
   - 單位：百分比 (%)

4. **溫濕度歷史圖表**
   - 使用圖表（如折線圖）展示溫濕度的歷史趨勢
   - X 軸：日期和時間
   - Y 軸：溫度/濕度數值
   - 建議使用雙 Y 軸或分開的圖表來同時顯示溫度和濕度

## 功能需求

### 核心功能

1. **即時數據顯示**
   - 從 MQTT Broker 訂閱並接收即時數據
   - 自動更新介面上的顯示內容
   - 支援即時數據刷新

2. **數據儲存**
   - 將訂閱收到的所有數據自動儲存為 Excel 檔案
   - 建議包含以下欄位：
     - 時間戳記 (Timestamp)
     - 電燈狀態 (Light Status)
     - 溫度 (Temperature)
     - 濕度 (Humidity)
   - 檔案命名建議包含日期時間，便於管理

### 技術規格建議

- **MQTT 訂閱主題**：需定義具體的主題名稱（例如：`home/living_room/temperature`, `home/living_room/humidity`, `home/living_room/light`）
- **MQTT Broker 連線**：需設定 Broker 位址、埠號、認證資訊（如需要）
- **數據更新頻率**：建議定義數據接收和更新的頻率
- **Excel 儲存頻率**：建議定義數據儲存的頻率（即時儲存或批次儲存）

## 非功能性需求

- **效能**：應用程式應能即時響應 MQTT 訊息
- **穩定性**：需處理 MQTT 連線中斷的情況
- **使用者體驗**：介面應清晰易讀，數據更新流暢

---

## 開發完成狀態

### ✅ 已實現功能

本專案已完成開發並通過測試，所有需求功能均已實現。

### 技術實現架構

#### 1. **系統架構**

```
┌─────────────────┐
│  MQTT Broker    │ (Mosquitto)
│  (localhost)    │
└────────┬────────┘
         │ MQTT 訊息
         ▼
┌─────────────────┐
│ MQTT Subscriber │ (mqtt_subscriber.py)
│   模組          │
└────────┬────────┘
         │
         ├──► Streamlit UI (app.py)
         │    └──► 即時顯示 + 圖表
         │
         └──► Data Storage (data_storage.py)
              └──► Excel 檔案儲存
```

#### 2. **核心模組說明**

**`app.py`** - Streamlit 主應用程式
- 實現即時監控儀表板
- 整合 MQTT 訂閱與數據顯示
- 使用 Plotly 繪製互動式圖表
- 支援自動刷新功能
- 改進的連線管理（避免刷新時斷線）
- 安全的 Session State 管理

**`mqtt_subscriber.py`** - MQTT 訂閱者模組
- 實現 MQTT 連線管理
- 處理訊息接收與解析
- 支援 JSON 與純文字格式
- 執行緒安全的數據緩存

**`data_storage.py`** - 數據儲存模組
- 自動儲存數據到 Excel 檔案
- 支援批次儲存（可設定間隔）
- 檔案命名包含時間戳記
- 支援數據讀取與合併

**`config.py`** - 配置管理
- 集中管理所有設定
- 支援環境變數覆蓋
- 易於維護與擴展

#### 3. **使用者介面實現**

✅ **電燈狀態顯示**
- 使用圖示與顏色標記（🟢 開啟 / ⚫ 關閉 / ❓ 未知）
- 顯示最後更新時間

✅ **溫度顯示**
- 即時數值顯示（°C）
- 支援小數點顯示
- 顯示最後更新時間

✅ **濕度顯示**
- 即時數值顯示（%）
- 支援小數點顯示
- 顯示最後更新時間

✅ **溫濕度歷史圖表**
- 使用 Plotly 互動式圖表
- 雙 Y 軸設計（溫度/濕度）
- X 軸顯示日期時間
- 支援縮放與懸停顯示詳細資訊
- 最多保留 1000 筆歷史數據

✅ **側邊欄控制**
- MQTT 連線/斷線控制
- 自動刷新開關
- 手動儲存數據按鈕
- 連線狀態指示

✅ **數據表格**
- 可展開查看歷史數據表格
- 支援排序與篩選

#### 4. **功能實現細節**

**即時數據顯示**
- ✅ 自動訂閱 MQTT 主題：`home/living_room/#`
- ✅ 支援多種訊息格式（數值、文字、JSON）
- ✅ 自動更新顯示（可設定自動刷新間隔）
- ✅ 執行緒安全的數據處理

**數據儲存**
- ✅ 自動儲存到 `data/` 目錄
- ✅ Excel 檔案格式（使用 openpyxl）
- ✅ 檔案命名：`mqtt_data_YYYYMMDD_HHMMSS.xlsx`
- ✅ 包含欄位：時間戳記、電燈狀態、溫度、濕度
- ✅ 支援批次儲存（預設每 10 筆儲存一次，可設定為即時儲存）

**MQTT 連線管理**
- ✅ 自動重連機制
- ✅ 連線狀態顯示
- ✅ 錯誤處理與日誌記錄
- ✅ 連線穩定性改進（避免 Streamlit 刷新時斷線）
- ✅ 執行緒安全的連線狀態檢查

### 技術規格（已實現）

#### MQTT 設定
- **Broker 位址**：`localhost`（可在 config.py 修改）
- **埠號**：`1883`（標準 MQTT 埠）
- **訂閱主題**：
  - `home/living_room/temperature` - 溫度
  - `home/living_room/humidity` - 濕度
  - `home/living_room/light` - 電燈狀態
  - `home/living_room/#` - 所有客廳主題（萬用字元）
- **QoS 等級**：1（確保訊息送達）

#### 數據格式支援
- **數值格式**：`25.5`（溫度/濕度）
- **文字格式**：`on` / `off`（電燈狀態）
- **JSON 格式**：
  ```json
  {
    "temperature": 25.5,
    "humidity": 60.0,
    "light": "on"
  }
  ```

#### 數據更新頻率
- **MQTT 接收**：即時（無延遲）
- **UI 刷新**：可設定自動刷新（預設每 2 秒）
- **Excel 儲存**：每 10 筆數據儲存一次（可在 config.py 設定為 0 即時儲存）
=======
# MQTT 感測器監控應用程式 - 產品需求文件 (PRD)

## 📋 專案概述

建立一個基於 Web 的 MQTT 監控應用程式，用於即時監控和視覺化感測器數據，提供直觀的數據儀表板和歷史趨勢分析。

### 版本資訊

- **版本**：1.0.0
- **最後更新**：2025-11-30
- **實作框架**：Flask + Socket.IO（替代原 Streamlit 方案）

> **技術變更說明**：因 Streamlit 與 Raspberry Pi ARM 架構相容性問題，改用 Flask 實作，提供更好的效能和穩定性。

---

## 🎯 系統角色

- **應用程式角色**：MQTT 訂閱者（Subscriber）
- **功能定位**：即時數據監控與視覺化儀表板
- **部署環境**：Raspberry Pi（ARM64 架構）

---

## 🖥️ 使用者介面需求

### 1. 頂部狀態列

- **MQTT 連線狀態**
  - 視覺化連線指示燈（綠色 = 已連線，灰色 = 未連線）
  - 顯示連線狀態文字
  
- **系統資訊**
  - 最後更新時間戳記
  - 總數據記錄數

### 2. 數據顯示區（三個資訊卡片）

#### 卡片 1：電燈狀態
- 大型圓形視覺化指示器
- 狀態：開（黃色圓形，發光效果）/ 關（灰色圓形）
- 使用圖示：🟡（開）/ ⚫（關）

#### 卡片 2：客廳溫度
- 即時溫度數值顯示
- 單位：攝氏度（°C）
- 數值格式：小數點後一位
- 圖示：🌡️

#### 卡片 3：客廳濕度
- 即時濕度數值顯示
- 單位：百分比（%）
- 數值格式：小數點後一位
- 圖示：💧

### 3. 歷史趨勢圖表

- **圖表類型**：雙 Y 軸折線圖（Line Chart）
- **左側 Y 軸**：溫度（°C）- 紅色線條
- **右側 Y 軸**：濕度（%）- 藍色線條
- **X 軸**：時間（日期 + 時間）
- **互動功能**：
  - 滑鼠懸停顯示詳細數值
  - 響應式設計，適應不同螢幕尺寸

### 4. UI/UX 設計要求

- **配色方案**：漸層紫色背景（科技感）
- **卡片設計**：白色背景，圓角，陰影效果
- **響應式布局**：支援桌面和行動裝置
- **字體**：清晰易讀的系統字體
- **動畫效果**：卡片懸停時有輕微上浮效果

---

## ⚙️ 功能需求

### 核心功能

#### 1. MQTT 數據訂閱
- **訂閱主題**：`客廳/感測器`
- **QoS 等級**：1（至少一次傳遞）
- **數據格式**：JSON
- **自動重連**：連線中斷時自動嘗試重新連線

#### 2. 即時數據顯示
- 從 MQTT Broker 接收感測器數據
- 即時更新所有 UI 元件（無需手動刷新）
- 使用 WebSocket 技術推送更新
- 僅提供顯示功能（唯讀模式）

#### 3. 數據持久化
- **儲存格式**：CSV 和 Excel (.xlsx)
- **儲存時機**：每次收到新數據時自動儲存
- **數據欄位**：
  - 時間戳記（YYYY-MM-DD HH:MM:SS）
  - 電燈狀態（開/關）
  - 溫度（數值）
  - 濕度（數值）
- **儲存位置**：應用程式根目錄
- **檔案命名**：
  - `sensor_data.csv`（應用程式使用）
  - `sensor_data.xlsx`（人工查看）

#### 4. 歷史數據管理
- 保留最近 100 筆數據於記憶體
- 啟動時自動載入現有歷史數據
- 數據超過限制時，移除最舊的記錄

---

## 🔧 技術規格

### 後端技術

- **Web 框架**：Flask 3.1+
- **即時通訊**：Flask-SocketIO 5.5+
- **MQTT 客戶端**：paho-mqtt 2.1+
- **數據處理**：CSV（標準庫）
- **Excel 處理**：openpyxl 3.1+

### 前端技術

- **基礎技術**：HTML5 + CSS3 + JavaScript（ES6+）
- **圖表庫**：Chart.js 4.5+
- **即時通訊**：Socket.IO Client 4.5+
- **UI 框架**：原生 CSS（漸層、Flexbox、Grid）

### 通訊協定

- **MQTT 協定**：MQTT 3.1.1
- **Broker**：Mosquitto
- **預設埠號**：1883
- **WebSocket**：Socket.IO over HTTP

### 數據格式定義

#### MQTT 訊息格式（JSON）

```json
{
  "temperature": 25.5,
  "humidity": 60.0,
  "light_status": "開"
}
```

**欄位說明**：
- `temperature` 或 `temp`：溫度（浮點數）
- `humidity` 或 `humi`：濕度（浮點數）
- `light_status` 或 `light`：電燈狀態（字串："開"/"關"）

### 效能要求

- **啟動時間**：< 2 秒
- **記憶體佔用**：< 100 MB
- **CPU 使用率**：閒置時 < 5%
- **數據更新延遲**：< 500 ms
- **同時支援連線數**：10 個瀏覽器

---

## 🚀 部署需求

### 系統環境

- **作業系統**：Raspberry Pi OS（Debian-based）
- **Python 版本**：3.10+
- **套件管理器**：uv
- **MQTT Broker**：Mosquitto

### 網路需求

- **應用程式埠號**：8080
- **MQTT Broker 埠號**：1883
- **防火牆設定**：允許埠號 8080 和 1883
>>>>>>> b4cf2463aad741e65cb85e2e4cb424284ebb2d9b

### 檔案結構

```
lesson6/
<<<<<<< HEAD
├── app.py                    # Streamlit 主應用程式
├── config.py                 # 配置檔案
├── mqtt_subscriber.py        # MQTT 訂閱者模組
├── data_storage.py          # 數據儲存模組
├── test_mqtt_publish.py     # MQTT 測試發布腳本（Python）
├── test_mqtt.sh            # Shell 測試腳本（自動啟動虛擬環境）
├── test_mqtt_simple.sh      # Shell 快速測試腳本
├── run.sh                   # 應用程式啟動腳本
├── PRD.md                   # 產品需求文件（本檔案）
├── README.md                # 使用說明文件
├── TEST_GUIDE.md            # 測試指南
└── data/                    # 數據儲存目錄（自動建立）
    └── mqtt_data_*.xlsx     # Excel 數據檔案
```

### 依賴套件

- `streamlit>=1.28.0` - Web 應用程式框架
- `paho-mqtt>=2.1.0` - MQTT 客戶端
- `pandas>=2.0.0` - 數據處理
- `openpyxl>=3.1.0` - Excel 檔案處理
- `plotly>=5.17.0` - 互動式圖表

### 部署與執行

#### 安裝步驟
```bash
# 1. 安裝依賴
cd /home/pi/Documents/GitHub/20205_10_26_chihlee_pi_pico_Steve
uv sync

# 2. 確保 MQTT Broker 運行
sudo systemctl status mosquitto
# 如未運行：sudo systemctl start mosquitto
```

#### 執行應用程式
```bash
# 方法 1: 使用啟動腳本
cd lesson6
./run.sh

# 方法 2: 手動執行
source ../.venv/bin/activate
streamlit run app.py
```

#### 測試方法

**單次測試模式**（推薦用於快速測試）
```bash
# 使用 Shell 腳本（自動啟動虛擬環境）
./test_mqtt.sh

# 或使用 Python 腳本
source ../.venv/bin/activate
python test_mqtt_publish.py
```
單次測試會發送：
- 電燈狀態（ON）
- 溫度數據
- 濕度數據
- JSON 格式的完整數據
- **30 筆連續的模擬感測器數據**（每 1 秒一次）

**持續發布模式**（用於長時間測試）
```bash
# 使用預設值：每 1 秒發布一次，共 100 次
./test_mqtt.sh continuous

# 自訂參數
./test_mqtt.sh continuous 0.5 200  # 每 0.5 秒一次，共 200 次
./test_mqtt.sh continuous 1 100    # 每 1 秒一次，共 100 次
```

**手動發布測試**
```bash
mosquitto_pub -h localhost -t "home/living_room/temperature" -m "25.5" -q 1
mosquitto_pub -h localhost -t "home/living_room/humidity" -m "60.0" -q 1
mosquitto_pub -h localhost -t "home/living_room/light" -m "on" -q 1
```

詳細測試說明請參考 `TEST_GUIDE.md`。

### 功能驗證清單

- ✅ MQTT 連線與訂閱功能正常
- ✅ 電燈狀態即時顯示（支援 on/off/未知狀態）
- ✅ 溫度即時顯示（支援小數點）
- ✅ 濕度即時顯示（支援小數點）
- ✅ 溫濕度歷史圖表正常顯示與更新
- ✅ 數據自動儲存為 Excel 檔案
- ✅ 手動儲存功能正常
- ✅ 自動刷新功能正常（不會中斷 MQTT 連線）
- ✅ 連線狀態顯示正常
- ✅ 支援多種 MQTT 訊息格式
- ✅ 執行緒安全處理
- ✅ 錯誤處理機制
- ✅ 高頻率數據接收測試（每 0.5-1 秒）
- ✅ 大量數據處理測試（100+ 筆連續數據）

### 已知限制與未來改進

#### 當前限制
1. 歷史數據最多保留 1000 筆（記憶體限制）
2. Excel 儲存為批次模式（預設每 10 筆，可設定為即時儲存）
3. 單一 MQTT Broker 連線（未支援多 Broker）
4. 測試腳本預設頻率為 1 秒（可自訂，但建議不低於 0.1 秒以避免過載）

#### 未來改進建議
1. 支援數據庫儲存（SQLite/PostgreSQL）
2. 支援多設備監控
3. 添加數據匯出功能（CSV/JSON）
4. 添加告警功能（溫度/濕度異常）
5. 支援 MQTT 認證（用戶名/密碼）
6. 添加數據統計分析功能
7. 支援自訂主題訂閱
8. 添加數據過濾與搜尋功能

### 測試結果

- ✅ 單一訊息發布測試通過
- ✅ 連續數據發布測試通過（30 筆，每 1 秒一次）
- ✅ 持續發布測試通過（100 筆，每 1 秒一次）
- ✅ JSON 格式數據解析測試通過
- ✅ Excel 儲存功能測試通過
- ✅ 圖表顯示與更新測試通過
- ✅ 連線中斷處理測試通過
- ✅ 多主題訂閱測試通過
- ✅ Streamlit 刷新時連線穩定性測試通過
- ✅ 高頻率數據接收測試通過（每 0.5-1 秒）

### 文件與資源

- **使用說明**：`README.md`
- **測試指南**：`TEST_GUIDE.md`
- **產品需求**：`PRD.md`（本檔案）

---

## 總結

本專案已完整實現所有需求功能，包括：
- ✅ 即時 MQTT 數據監控
- ✅ 視覺化儀表板介面
- ✅ 歷史數據圖表
- ✅ 自動數據儲存
- ✅ 完整的測試工具（支援高頻率、大量數據測試）
- ✅ 穩定的連線管理（避免刷新時斷線）

**最新更新（v1.1）**：
- ✅ 測試腳本優化：單次測試從 5 筆增加到 30 筆
- ✅ 持續發布模式預設：每 1 秒 100 次（可自訂）
- ✅ MQTT 連線穩定性改進：解決 Streamlit 刷新時斷線問題
- ✅ 自動重連機制優化

應用程式已可正常運行，並通過各項功能測試，包括高頻率數據接收和大批量數據處理測試。所有程式碼遵循最佳實踐，具有良好的可維護性和擴展性。 
=======
├── app_flask.py              # 主應用程式
├── templates/
│   └── index.html            # 網頁模板
├── sensor_data.csv           # CSV 數據
├── sensor_data.xlsx          # Excel 數據
├── start.sh                  # 啟動腳本
└── README.md                 # 說明文件
```

---

## 📊 測試需求

### 功能測試

1. **MQTT 連線測試**
   - 正常連線情境
   - 斷線重連情境
   - Broker 未啟動情境

2. **數據接收測試**
   - 正常 JSON 數據
   - 不完整數據處理
   - 非 JSON 格式處理

3. **UI 更新測試**
   - 即時更新驗證
   - 多筆數據連續接收
   - 圖表正確渲染

4. **數據儲存測試**
   - CSV 檔案正確寫入
   - Excel 檔案正確寫入
   - 檔案權限驗證

### 效能測試

- 連續接收 100 筆數據無延遲
- 記憶體不會持續增長
- 長時間運行（24 小時）穩定性

---

## 🔮 未來擴充建議

### 第一階段（已完成）
- ✅ 即時數據顯示
- ✅ 歷史趨勢圖表
- ✅ 數據持久化（CSV + Excel）
- ✅ WebSocket 即時更新

### 第二階段（可選）
- 數據篩選與查詢功能
- 自訂時間範圍查詢
- 數據匯出功能（PDF、圖片）
- 異常值警報通知

### 第三階段（進階）
- 多房間監控支援
- 使用者認證與權限管理
- 歷史數據回放功能
- 行動 APP（React Native）

### 第四階段（AI/ML）
- 溫濕度預測分析
- 異常模式偵測
- 智慧化控制建議
- 數據統計報表生成

---

## 📝 附註

### 技術決策說明

**為何選擇 Flask 而非 Streamlit？**

1. **相容性**：Streamlit 在 Raspberry Pi ARM64 架構上有相容性問題（SIGILL 錯誤）
2. **效能**：Flask 記憶體佔用少（~50MB vs ~300MB），啟動快速（<1s vs 5-10s）
3. **靈活性**：Flask 提供更多自訂空間，WebSocket 整合更容易
4. **穩定性**：經過充分測試，在 Raspberry Pi 上運行穩定

### 已知限制

- 目前僅支援單一 MQTT 主題訂閱
- 歷史數據僅保留最近 100 筆於記憶體
- 無使用者認證機制（適用於內網環境）
- 圖表互動功能有限（基於 Chart.js）

### 版本歷史

- **v1.0.0**（2025-11-30）：初版發布，使用 Flask 實作
- ~~v0.1.0（計劃中）：Streamlit 版本（因相容性問題取消）~~
>>>>>>> b4cf2463aad741e65cb85e2e4cb424284ebb2d9b
